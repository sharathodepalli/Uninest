(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[750],{1471:function(e,s,r){Promise.resolve().then(r.bind(r,1748))},1748:function(e,s,r){"use strict";r.r(s),r.d(s,{default:function(){return _}});var t=r(7437),a=r(2265),n=r(9376),i=r(8808),l=r(6070),d=r(6831),c=r(5974),o=r(2718),u=r(456);function m(e){let{threads:s,loading:r,selectedThread:a,onSelectThread:n}=e;return r?(0,t.jsxs)(l.Zb,{className:"h-full",children:[(0,t.jsx)(l.Ol,{children:(0,t.jsxs)(l.ll,{className:"flex items-center gap-2",children:[(0,t.jsx)(o.Z,{className:"h-5 w-5"}),"Messages"]})}),(0,t.jsx)(l.aY,{className:"space-y-4",children:[void 0,void 0,void 0,void 0,void 0].map((e,s)=>(0,t.jsxs)("div",{className:"flex items-center gap-3 animate-pulse",children:[(0,t.jsx)("div",{className:"w-10 h-10 bg-muted rounded-full"}),(0,t.jsxs)("div",{className:"flex-1 space-y-2",children:[(0,t.jsx)("div",{className:"h-4 bg-muted rounded w-3/4"}),(0,t.jsx)("div",{className:"h-3 bg-muted rounded w-1/2"})]})]},s))})]}):(0,t.jsxs)(l.Zb,{className:"h-full",children:[(0,t.jsx)(l.Ol,{children:(0,t.jsxs)(l.ll,{className:"flex items-center gap-2",children:[(0,t.jsx)(o.Z,{className:"h-5 w-5"}),"Messages"]})}),(0,t.jsx)(l.aY,{className:"p-0",children:0===s.length?(0,t.jsxs)("div",{className:"p-6 text-center",children:[(0,t.jsx)(o.Z,{className:"h-8 w-8 text-muted-foreground mx-auto mb-2"}),(0,t.jsx)("p",{className:"text-sm text-muted-foreground",children:"No conversations yet"})]}):(0,t.jsx)("div",{className:"space-y-1",children:s.map(e=>(0,t.jsx)("div",{className:"p-4 cursor-pointer hover:bg-muted/50 transition-colors border-l-4 ".concat((null==a?void 0:a.listingId)===e.listing_id&&(null==a?void 0:a.otherUserId)===e.other_user.id?"border-primary bg-muted/50":"border-transparent"),onClick:()=>n({listingId:e.listing_id,otherUserId:e.other_user.id,otherUserName:e.other_user.name}),children:(0,t.jsxs)("div",{className:"flex items-start gap-3",children:[(0,t.jsxs)(d.Avatar,{className:"h-10 w-10",children:[(0,t.jsx)(d.AvatarImage,{src:e.other_user.photo_url||""}),(0,t.jsx)(d.AvatarFallback,{children:e.other_user.name.charAt(0).toUpperCase()})]}),(0,t.jsxs)("div",{className:"flex-1 min-w-0",children:[(0,t.jsxs)("div",{className:"flex items-center justify-between mb-1",children:[(0,t.jsx)("h4",{className:"font-medium truncate",children:e.other_user.name}),e.unread_count>0&&(0,t.jsx)(c.C,{variant:"destructive",className:"text-xs",children:e.unread_count})]}),(0,t.jsx)("p",{className:"text-sm text-muted-foreground truncate",children:e.last_message.content}),(0,t.jsx)("p",{className:"text-xs text-muted-foreground mt-1",children:(0,u.Q)(new Date(e.last_message.created_at),{addSuffix:!0})})]})]})},"".concat(e.listing_id,"-").concat(e.other_user.id)))})})]})}var h=r(2869),x=r(6818),f=r(4743),g=r(4098),p=r(9033);function v(e){let{listingId:s,otherUserId:r,otherUserName:n}=e,{user:i}=(0,p.a)(),{messages:c,loading:o,sendMessage:m,markAsRead:v}=(0,g.R)(s),[j,_]=(0,a.useState)(""),[N,b]=(0,a.useState)(!1),y=(0,a.useRef)(null);(0,a.useEffect)(()=>{var e;null===(e=y.current)||void 0===e||e.scrollIntoView({behavior:"smooth"})},[c]),(0,a.useEffect)(()=>{c.length>0&&v(s,r)},[c,s,r,v]);let w=async()=>{if(!j.trim()||N)return;b(!0);let e=j.trim();_("");try{await m(s,r,e)}catch(s){console.error("Error sending message:",s),_(e)}finally{b(!1)}};return o?(0,t.jsxs)(l.Zb,{className:"h-full",children:[(0,t.jsx)(l.Ol,{children:(0,t.jsx)(l.ll,{children:"Loading..."})}),(0,t.jsx)(l.aY,{className:"flex-1 flex items-center justify-center",children:(0,t.jsx)("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-primary"})})]}):(0,t.jsxs)(l.Zb,{className:"h-full flex flex-col",children:[(0,t.jsx)(l.Ol,{className:"border-b",children:(0,t.jsxs)(l.ll,{className:"flex items-center gap-3",children:[(0,t.jsx)(d.Avatar,{className:"h-8 w-8",children:(0,t.jsx)(d.AvatarFallback,{children:n.charAt(0).toUpperCase()})}),n]})}),(0,t.jsxs)(l.aY,{className:"flex-1 flex flex-col p-0",children:[(0,t.jsxs)("div",{className:"flex-1 overflow-y-auto p-4 space-y-4",children:[0===c.length?(0,t.jsx)("div",{className:"text-center text-muted-foreground py-8",children:(0,t.jsx)("p",{children:"No messages yet. Start the conversation!"})}):c.map(e=>{let s=e.sender_id===(null==i?void 0:i.id);return(0,t.jsx)("div",{className:"flex ".concat(s?"justify-end":"justify-start"),children:(0,t.jsxs)("div",{className:"flex gap-2 max-w-[70%] ".concat(s?"flex-row-reverse":"flex-row"),children:[(0,t.jsxs)(d.Avatar,{className:"h-8 w-8",children:[(0,t.jsx)(d.AvatarImage,{src:e.sender.photo_url||""}),(0,t.jsx)(d.AvatarFallback,{children:e.sender.name.charAt(0).toUpperCase()})]}),(0,t.jsxs)("div",{className:"space-y-1 ".concat(s?"text-right":"text-left"),children:[(0,t.jsx)("div",{className:"inline-block p-3 rounded-lg ".concat(s?"bg-primary text-primary-foreground":"bg-muted"),children:(0,t.jsx)("p",{className:"text-sm whitespace-pre-wrap",children:e.content})}),(0,t.jsx)("p",{className:"text-xs text-muted-foreground",children:(0,u.Q)(new Date(e.created_at),{addSuffix:!0})})]})]})},e.id)}),(0,t.jsx)("div",{ref:y})]}),(0,t.jsx)("div",{className:"border-t p-4",children:(0,t.jsxs)("div",{className:"flex gap-2",children:[(0,t.jsx)(x.g,{placeholder:"Type your message...",value:j,onChange:e=>_(e.target.value),onKeyPress:e=>{"Enter"!==e.key||e.shiftKey||(e.preventDefault(),w())},rows:2,className:"resize-none"}),(0,t.jsx)(h.z,{onClick:w,disabled:!j.trim()||N,size:"sm",children:N?(0,t.jsx)("div",{className:"h-4 w-4 animate-spin rounded-full border-2 border-background border-t-transparent"}):(0,t.jsx)(f.Z,{className:"h-4 w-4"})})]})})]})]})}function j(){let{user:e}=(0,p.a)(),s=(0,n.useSearchParams)(),[r,d]=(0,a.useState)(null),{threads:c,loading:u}=(0,g.R)();return((0,a.useEffect)(()=>{let e=s.get("listing"),r=s.get("host");if(e&&r&&c.length>0){let s=c.find(s=>s.listing_id===e&&s.other_user.id===r);s&&d({listingId:s.listing_id,otherUserId:s.other_user.id,otherUserName:s.other_user.name})}},[s,c]),e)?(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)(i.Header,{}),(0,t.jsx)("div",{className:"container mx-auto px-4 py-8",children:(0,t.jsxs)("div",{className:"grid grid-cols-1 lg:grid-cols-4 gap-6 h-[calc(100vh-200px)]",children:[(0,t.jsx)("div",{className:"lg:col-span-1",children:(0,t.jsx)(m,{threads:c,selectedThread:r,onSelectThread:d,loading:u})}),(0,t.jsx)("div",{className:"lg:col-span-3",children:r?(0,t.jsx)(v,{listingId:r.listingId,otherUserId:r.otherUserId,otherUserName:r.otherUserName}):(0,t.jsx)(l.Zb,{className:"h-full flex items-center justify-center",children:(0,t.jsxs)("div",{className:"text-center",children:[(0,t.jsx)(o.Z,{className:"h-12 w-12 mx-auto mb-4 text-muted-foreground"}),(0,t.jsx)("h3",{className:"text-lg font-semibold mb-2",children:"Select a conversation"}),(0,t.jsx)("p",{className:"text-muted-foreground",children:"Choose a conversation from the sidebar to start messaging."})]})})})]})})]}):(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)(i.Header,{}),(0,t.jsx)("div",{className:"container mx-auto px-4 py-8",children:(0,t.jsxs)(l.Zb,{className:"p-8 text-center",children:[(0,t.jsx)(o.Z,{className:"h-12 w-12 mx-auto mb-4 text-muted-foreground"}),(0,t.jsx)("h1",{className:"text-2xl font-bold mb-2",children:"Messages"}),(0,t.jsx)("p",{className:"text-muted-foreground",children:"Please sign in to view your messages."})]})})]})}function _(){return(0,t.jsx)(a.Suspense,{fallback:(0,t.jsx)("div",{children:"Loading messages..."}),children:(0,t.jsx)(j,{})})}},5974:function(e,s,r){"use strict";r.d(s,{C:function(){return l}});var t=r(7437);r(2265);var a=r(7712),n=r(4508);let i=(0,a.j)("inline-flex items-center rounded-full border px-2.5 py-0.5 text-xs font-semibold transition-colors focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2",{variants:{variant:{default:"border-transparent bg-primary text-primary-foreground hover:bg-primary/80",secondary:"border-transparent bg-secondary text-secondary-foreground hover:bg-secondary/80",destructive:"border-transparent bg-destructive text-destructive-foreground hover:bg-destructive/80",outline:"text-foreground"}},defaultVariants:{variant:"default"}});function l(e){let{className:s,variant:r,...a}=e;return(0,t.jsx)("div",{className:(0,n.cn)(i({variant:r}),s),...a})}},6818:function(e,s,r){"use strict";r.d(s,{g:function(){return i}});var t=r(7437),a=r(2265),n=r(4508);let i=a.forwardRef((e,s)=>{let{className:r,...a}=e;return(0,t.jsx)("textarea",{className:(0,n.cn)("flex min-h-[80px] w-full rounded-md border border-input bg-background px-3 py-2 text-sm ring-offset-background placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50",r),ref:s,...a})});i.displayName="Textarea"},4098:function(e,s,r){"use strict";r.d(s,{R:function(){return i}});var t=r(2265),a=r(2141),n=r(9033);function i(e){let{user:s}=(0,n.a)(),[r,i]=(0,t.useState)([]),[l,d]=(0,t.useState)([]),[c,o]=(0,t.useState)(!0),[u,m]=(0,t.useState)(null),h=(0,t.useCallback)(async e=>{if(s)try{o(!0);let{data:r,error:t}=await a.OQ.from("messages").select("\n          *,\n          sender:sender_id (\n            name,\n            photo_url\n          )\n        ").eq("listing_id",e).or("sender_id.eq.".concat(s.id,",receiver_id.eq.").concat(s.id)).order("created_at",{ascending:!0});if(t)throw t;i(r)}catch(e){m(e instanceof Error?e.message:"An error occurred")}finally{o(!1)}},[s]),x=(0,t.useCallback)(async()=>{if(s)try{o(!0);let{data:e,error:r}=await a.OQ.from("messages").select("\n          *,\n          listings:listing_id (\n            title,\n            host_id\n          ),\n          sender:sender_id (\n            id,\n            name,\n            photo_url\n          ),\n          receiver:receiver_id (\n            id,\n            name,\n            photo_url\n          )\n        ").or("sender_id.eq.".concat(s.id,",receiver_id.eq.").concat(s.id)).order("created_at",{ascending:!1});if(r)throw r;let t=new Map;null==e||e.forEach(e=>{let r=e.sender_id===s.id?e.receiver:e.sender,a="".concat(e.listing_id,"-").concat(r.id);if(t.has(a)){let r=t.get(a);e.sender_id!==s.id&&!e.read_at&&r.unread_count++}else t.set(a,{listing_id:e.listing_id,other_user:r,last_message:{content:e.content,created_at:e.created_at,sender_id:e.sender_id},unread_count:e.sender_id===s.id||e.read_at?0:1})}),d(Array.from(t.values()))}catch(e){m(e instanceof Error?e.message:"An error occurred")}finally{o(!1)}},[s]),f=async(e,r,t)=>{if(!s)return{error:"Not authenticated"};try{let{data:n,error:l}=await a.OQ.from("messages").insert({listing_id:e,sender_id:s.id,receiver_id:r,content:t}).select("\n          *,\n          sender:sender_id (\n            name,\n            photo_url\n          )\n        ").single();if(l)throw l;return e==e&&i(e=>[...e,n]),x(),{data:n,error:null}}catch(e){return{data:null,error:e instanceof Error?e.message:"An error occurred"}}},g=async(e,r)=>{if(s)try{await a.OQ.from("messages").update({read_at:new Date().toISOString()}).eq("listing_id",e).eq("sender_id",r).eq("receiver_id",s.id).is("read_at",null),i(t=>t.map(t=>t.listing_id===e&&t.sender_id===r&&t.receiver_id===s.id?{...t,read_at:new Date().toISOString()}:t)),x()}catch(e){console.error("Error marking messages as read:",e)}};return(0,t.useEffect)(()=>{if(!s||!e)return;let r=a.OQ.channel("messages:".concat(e)).on("postgres_changes",{event:"INSERT",schema:"public",table:"messages",filter:"listing_id=eq.".concat(e)},async e=>{let{data:s}=await a.OQ.from("messages").select("\n              *,\n              sender:sender_id (\n                name,\n                photo_url\n              )\n            ").eq("id",e.new.id).single();s&&i(e=>[...e,s])}).subscribe();return()=>{a.OQ.removeChannel(r)}},[s,e]),(0,t.useEffect)(()=>{e?h(e):x()},[e,h,x]),{messages:r,threads:l,loading:c,error:u,sendMessage:f,markAsRead:g,refetchMessages:()=>e&&h(e),refetchThreads:x}}},4743:function(e,s,r){"use strict";r.d(s,{Z:function(){return t}});let t=(0,r(9205).Z)("Send",[["path",{d:"M14.536 21.686a.5.5 0 0 0 .937-.024l6.5-19a.496.496 0 0 0-.635-.635l-19 6.5a.5.5 0 0 0-.024.937l7.93 3.18a2 2 0 0 1 1.112 1.11z",key:"1ffxy3"}],["path",{d:"m21.854 2.147-10.94 10.939",key:"12cjpa"}]])}},function(e){e.O(0,[438,580,212,648,964,562,456,919,971,117,744],function(){return e(e.s=1471)}),_N_E=e.O()}]);